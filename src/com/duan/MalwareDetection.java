package com.duan;

import com.duan.analysis.FunctionsAnalysis;
import com.duan.analysis.PermissionAnalysis;
import com.duan.common.ApkDetection;
import com.duan.common.ComPrint;
import com.duan.common.Comm;
import com.duan.common.FileUtil;
import com.duan.db.DBControl;
import com.duan.db.DBMalwareHelper;
import com.duan.decompile.Decompiler;
import com.duan.table_manager.FunctionsManager;
import com.duan.table_manager.PermissionManager;
import com.duan.table_manager.SamplesManager;
import org.fusesource.jansi.Ansi;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Iterator;

import static com.duan.common.ComString.DECOMPILE_PATH;
import static org.fusesource.jansi.Ansi.ansi;

/**
 * Created by DuanJiaNing on 2017/4/27.
 */
public class MalwareDetection {

    Collection<?> permissions;
    Collection<?> functions;

    private final String T = DBMalwareHelper.MALWARE_TYPE_TROJAN_VIRUS_SW;
    private final String P = DBMalwareHelper.MALWARE_TYPE_PHISHING_SW;
    private final String S = DBMalwareHelper.MALWARE_TYPE_SEX_SW;
    private final String R = DBMalwareHelper.MALWARE_TYPE_RANSOMWARE_SW;
    private final String O = DBMalwareHelper.MALWARE_TYPE_OTHER_SW;


    @ApkDetection("开始检测apk是否为恶意APP")
    public void startDetection() {

        new SamplesManager().checkTest();

        Decompiler decompiler = new Decompiler(true, true);
        decompiler.setOnDecompileFinish(() -> {

                permissions = new PermissionAnalysis().analysisTest().getContainerSet();
                calculatePermisSimilar();

                functions = new FunctionsAnalysis().analysisTest().getContainerSet();
                calculateFunctionSimilar();
        });

        decompiler.decompileTestAPK();

    }

    //检测完成
    private void detectionFinish() {
        SamplesManager.Samples t[] = new SamplesManager().getSampleInfo(DBMalwareHelper.MALWARE_TYPE_TEST_SW);
        FileUtil.delDir(DECOMPILE_PATH + t[0].getType() + "\\" + t[0].getPackageName(), true);
        System.exit(1);
    }

    //输出检测结果
    private void reportPer(PermisSimilar... lps) {

        ComPrint.info("权限相似度计算完成");
        System.out.println(ansi().eraseScreen().fg(getColor(lps[0].value)).a("木马软件:\t" + lps[0].value).reset());
        System.out.println(ansi().eraseScreen().fg(getColor(lps[1].value)).a("钓鱼软件:\t" + lps[1].value).reset());
        System.out.println(ansi().eraseScreen().fg(getColor(lps[2].value)).a("色情软件:\t" + lps[2].value).reset());
        System.out.println(ansi().eraseScreen().fg(getColor(lps[3].value)).a("勒索软件:\t" + lps[3].value).reset());
        System.out.println(ansi().eraseScreen().fg(getColor(lps[4].value)).a("其他类型:\t" + lps[4].value).reset());

    }

    private void reportFun(FunctionSimilar... lps) {

        ComPrint.info("方法调用相似度计算完成");
        System.out.println(ansi().eraseScreen().fg(getColor(lps[0].value)).a("木马软件:\t" + lps[0].value).reset());
        System.out.println(ansi().eraseScreen().fg(getColor(lps[1].value)).a("钓鱼软件:\t" + lps[1].value).reset());
        System.out.println(ansi().eraseScreen().fg(getColor(lps[2].value)).a("色情软件:\t" + lps[2].value).reset());
        System.out.println(ansi().eraseScreen().fg(getColor(lps[3].value)).a("勒索软件:\t" + lps[3].value).reset());
        System.out.println(ansi().eraseScreen().fg(getColor(lps[4].value)).a("其他类型:\t" + lps[4].value).reset());

        detectionFinish();

    }

    private Ansi.Color getColor(float f) {
        Ansi.Color color;
        float v = f;
        if (v - 0.7 > 0.000001)
            color = Ansi.Color.MAGENTA;
        else if (v - 0.5 > 0.000001 && v - 0.7 < 0.0000001)
            color = Ansi.Color.CYAN;
        else
            color = Ansi.Color.WHITE;

        return color;
    }

    //计算待测 apk 与样本的权限申请相似度
    private void calculatePermisSimilar() {
        ComPrint.normal("计算权限相似度...");
        PermissionManager manager = new PermissionManager();
        PermisSimilar psT = new PermisSimilar(T, getPermRatio(manager.getPermissions(T)));
        PermisSimilar psP = new PermisSimilar(P, getPermRatio(manager.getPermissions(P)));
        PermisSimilar psS = new PermisSimilar(S, getPermRatio(manager.getPermissions(S)));
        PermisSimilar psR = new PermisSimilar(R, getPermRatio(manager.getPermissions(R)));
        PermisSimilar psO = new PermisSimilar(O, getPermRatio(manager.getPermissions(O)));

        reportPer(psT, psR, psP, psS, psO);

    }

    //计算待测 apk 与样本的方法调用相似度
    private void calculateFunctionSimilar() {
        ComPrint.normal("计算方法调用相似度...");
        FunctionsManager manager = new FunctionsManager();
        FunctionSimilar fuT = new FunctionSimilar(T, getFunRatio(manager.getFunctions(T), T));
        FunctionSimilar fuP = new FunctionSimilar(P, getFunRatio(manager.getFunctions(P), P));
        FunctionSimilar fuS = new FunctionSimilar(S, getFunRatio(manager.getFunctions(S), S));
        FunctionSimilar fuR = new FunctionSimilar(R, getFunRatio(manager.getFunctions(R), R));
        FunctionSimilar fuO = new FunctionSimilar(O, getFunRatio(manager.getFunctions(O), O));

        reportFun(fuT, fuR, fuP, fuS, fuO);

    }

    private float getPermRatio(ArrayList<PermissionManager.Permission> list) {
        float co = 0;
        for (int i = 0; i < list.size(); i++) {
            PermissionManager.Permission p = list.get(i);
            Iterator<PermissionManager.Permission> iterator = (Iterator<PermissionManager.Permission>) permissions.iterator();
            while (iterator.hasNext()) {
                if (iterator.next().getName().equals(p.getName()))
                    co++;
            }
        }
        return co / permissions.size() - Comm.DF;
    }

    private float getFunRatio(ArrayList<FunctionsManager.Function> list, String t) {
        float co = 0;
        int sum = DBControl.countByType(t, DBMalwareHelper.TABLE_SAMPLES);
        for (int i = 0; i < list.size(); i++) {
            FunctionsManager.Function f = list.get(i);
            Iterator<FunctionsManager.Function> it = (Iterator<FunctionsManager.Function>) functions.iterator();
            while (it.hasNext()) {
                FunctionsManager.Function fc = it.next();
                if (fc.getClasS().equals(f.getClasS()) && fc.getSignature().equals(f.getSignature())) {
//                    int in = (int) (fc.getRatio() - f.getRatio() * sum);
//                    if (in > 12)
//                        co += in / 12;
//                    else
//                        co += 1;
                    co++;
                }
            }
        }
        return co / functions.size() - Comm.DF;
    }

    private class PermisSimilar {
        String type;
        float value;

        public PermisSimilar(String type, float value) {
            this.type = type;
            this.value = value;
        }
    }

    private class FunctionSimilar {
        String type;
        float value;

        public FunctionSimilar(String type, float value) {
            this.type = type;
            this.value = value;
        }
    }

}
